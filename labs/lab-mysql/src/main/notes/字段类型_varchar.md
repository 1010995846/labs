varchar(M)的M是说字数，而不是字节。



> InnoDB章节中解释了变长最大值为`2^16 - 1 = 65535`字节。



各字符集编码占位字节

| 字符集  | 占位字节W | 英文占位字符数 | 中文占位字符数 |
| ------- | --------- | -------------- | -------------- |
| utf8mb4 | 4         | 1              | 3              |
| utf8    | 3         | 1              |                |
| gbk     | 2         | 1              | 2              |
| ascii   | 1         | 1              |                |

因此若编码为utf8mb4，则varchar支持的最大长度为`⌊65535 % 4⌋ = 16383`。

行最大长度是65535字节，但是行里面有很多东西，包括变长字段列表、NULL值列表、记录头信息。你得考虑该字段如果允许为NULL，NULL值列表会占用一个字节(只要没超过8个字段)，每一列字段的变长字段实际长度会花费1~2个字节，如果该字段的数据太大，会变成溢出列，该字段的数据会分成很多行存储（后面会讲，你可以看完NULL值列表和溢出列后再回来看这个例子）。所以即便提示16383个字符，你也绝对不可能存到16383。

查询字符长度

```mysql
select length(column) from table;
```

**规则一：如果允许存储的最大字节数 < 255，varchar占用的真实字节数L只分配1个字节来表示。**

注意：每种编码的占位字节W、各符号字符数不一致。

例：在utf8mb4编码下，输入n个全中文，若要最大字节数 < 255，则为 4 × 3 × n < 255，即 n <= 21

**规则二：如果允许存储的最大字节数 > 255，则分为两种情况：**

如果实际存储字节L <= 127，varchar占用的真实字节数L仅分配1个字节就能表示。

如果实际存储字节L > 127，varchar占用的真实字节数L需要分配2个字节才能表示。